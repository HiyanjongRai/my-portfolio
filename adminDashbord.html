<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7f8fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    --brand:#1d4ed8; --soft:#f1f5f9; --shadow:0 1px 2px rgba(15,23,42,.04), 0 10px 30px rgba(15,23,42,.06);
    --danger:#ef4444; --success:#16a34a;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh}

  /* Sidebar */
  aside{background:#fff;border-right:1px solid var(--border);padding:18px 12px;position:sticky;top:0;height:100vh}
  .brand{display:flex;align-items:center;gap:8px;padding:6px 8px 16px;border-bottom:1px solid var(--border)}
  .spark{width:28px;height:28px;border-radius:8px;background:var(--soft);color:var(--brand);display:grid;place-items:center;font-weight:800;box-shadow:inset 0 0 0 2px rgba(29,78,216,.15)}
  .brand span{font-weight:800}
  .sidenav{display:grid;gap:6px;margin-top:12px}
  .slink{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;text-decoration:none;color:#111827}
  .slink:hover{background:var(--soft)} .slink.active{background:#eef2ff;color:var(--brand)}
  .sicon{width:22px;text-align:center}

  /* Topbar */
  header.top{grid-column:2;position:sticky;top:0;z-index:5;background:var(--bg);
    display:flex;justify-content:space-between;align-items:center;padding:12px 20px}
  .tabs{list-style:none;display:flex;gap:12px;margin:0;padding:0}
  .tab{padding:8px 10px;border-radius:8px;text-decoration:none;color:#374151;font-weight:500}
  .tab.active{background:#e5edff;color:var(--brand)}
  .top-actions{display:flex;align-items:center;gap:8px}
  .iconbtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 8px;box-shadow:var(--shadow);cursor:pointer}
  .avatar{width:32px;height:32px;border-radius:50%;display:grid;place-items:center;background:var(--brand);color:#fff;font-weight:700}

  /* Main + cards */
  main{grid-column:2;padding:16px 22px 40px;display:grid;gap:18px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .panel{padding:16px}
  .muted{color:var(--muted)} h1{margin:0 0 6px 0;font-size:22px} h2{margin:0 0 12px 0;font-size:18px}

  /* Dashboard */
  .welcome .metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin:16px 0 6px}
  .metric .num{font-size:34px;font-weight:800;color:var(--brand)} .metric .lab{color:var(--muted)}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  .qa{display:grid;gap:12px}
  .qa-item{display:grid;grid-template-columns:44px 1fr auto;gap:12px;align-items:center;padding:12px;border:1px solid var(--border);
    border-radius:14px;background:#fbfdff;text-decoration:none;color:inherit}
  .qa-item:hover{background:#f3f6ff}
  .qa-icon{width:44px;height:44px;border-radius:12px;display:grid;place-items:center;background:#eef2ff;color:var(--brand);font-size:20px}
  .qa-title{font-weight:600} .qa-sub{color:var(--muted);font-size:14px} .chev{color:var(--muted);font-size:22px;padding:0 6px}
  .activity{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  .activity li{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;padding:8px 6px;border-radius:10px}
  .activity li:hover{background:#f8fafc}
  .activity .ic{width:36px;height:36px;border-radius:10px;background:#fff7ed;border:1px solid var(--border);display:grid;place-items:center}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
  .stat .top{display:flex;align-items:center;gap:10px}
  .stat .ico{width:32px;height:32px;border-radius:10px;background:#eef2ff;color:var(--brand);display:grid;place-items:center}
  .stat .num{font-size:30px;font-weight:800;padding-top:6px;color:#0b3cc1}

  /* Posts screen */
  .row{display:grid;gap:8px;margin-bottom:14px}
  label{font-size:14px;font-weight:600}
  input[type="text"], textarea{width:100%;border:1px solid var(--border);border-radius:12px;background:#fff;padding:10px 12px;font:inherit;outline:none}
  textarea{min-height:120px;resize:vertical}
  .drop{border:2px dashed #e2e8f0;border-radius:14px;background:#fbfdff;padding:18px;display:grid;place-items:center;text-align:center;color:var(--muted)}
  .drop .preview{display:flex;gap:14px;align-items:center;margin-top:10px}
  .drop img{width:140px;height:80px;object-fit:cover;border:1px solid var(--border);border-radius:10px;background:#fff}
  .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .btn{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.gray{background:#f8fafc} .btn.icon{padding:8px 10px;border-radius:10px}
  .btn.danger{background:var(--danger);border-color:var(--danger);color:#fff}
  .table-wrap{overflow:auto;border-top-left-radius:16px;border-top-right-radius:16px}
  table{width:100%;border-collapse:collapse}
  thead th{background:#f8fafc;border-bottom:1px solid var(--border);text-align:left;font-size:14px;padding:12px}
  tbody td{border-bottom:1px solid var(--border);padding:14px 12px;vertical-align:top;font-size:14px}
  .cell-img img{width:72px;height:44px;object-fit:cover;border-radius:8px;border:1px solid var(--border)}

  /* Toast */
  .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:var(--shadow);opacity:0;transform:translateY(10px);transition:.2s}
  .toast.show{opacity:1;transform:translateY(0)}
  .toast.success{background:var(--success)} .toast.error{background:var(--danger)}

  /* Responsive */
  @media (max-width:1100px){
    .layout{grid-template-columns:80px 1fr}
    .brand span{display:none}
    .slink span:nth-child(2){display:none}
  }
  @media (max-width:860px){
    .grid-2{grid-template-columns:1fr}
    .welcome .metrics{grid-template-columns:1fr}
    .stats{grid-template-columns:1fr 1fr}
  }
  @media (max-width:640px){
    aside{display:none} header.top{position:static} .stats{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="layout">
  <!-- Sidebar -->
  <aside>
    <div class="brand"><div class="spark">*</div><span>logo</span></div>
    <nav class="sidenav">
      <a class="slink active" id="nav-dashboard" href="javascript:void(0)"><span class="sicon">üè†</span><span>Dashboard</span></a>
      <a class="slink" id="nav-posts" href="javascript:void(0)"><span class="sicon">üìù</span><span>Posts</span></a>
      <a class="slink" id="nav-projects" href="javascript:void(0)"><span class="sicon">üìÅ</span><span>Projects</span></a>
      <a class="slink" href="javascript:void(0)"><span class="sicon">‚öôÔ∏è</span><span>Settings</span></a>
      <a class="slink" id="logout" href="javascript:void(0)"><span class="sicon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <!-- Topbar -->
  <header class="top">
    <ul class="tabs">
      <li><a class="tab active" data-tab="dash" href="javascript:void(0)">Dashboard</a></li>
      <li><a class="tab" data-tab="posts" href="javascript:void(0)">Posts</a></li>
      <li><a class="tab" data-tab="projects" href="javascript:void(0)">Projects</a></li>
      <li><a class="tab" data-tab="settings" href="javascript:void(0)">Settings</a></li>
    </ul>
    <div class="top-actions">
      <button class="iconbtn" title="Notifications">üîî</button>
      <button class="iconbtn" title="Shortcuts">‚¨ÜÔ∏è</button>
      <div class="avatar" id="avatar">JD</div>
    </div>
  </header>

  <!-- Main -->
  <main>
    <!-- DASHBOARD -->
    <section id="dash-section">
      <div class="card panel welcome">
        <h1>Welcome back, <span id="welcomeName">Jane Doe</span>!</h1>
        <p class="muted">Here's an overview of your portfolio activity.</p>
        <div class="metrics">
          <div class="metric"><div class="num" id="metricPosts">0</div><div class="lab">Total Posts</div></div>
          <div class="metric"><div class="num" id="metricProjects">0</div><div class="lab">Total Projects</div></div>
          <div class="metric"><div class="num" id="metricItems">0</div><div class="lab">Total Content Items</div></div>
        </div>
        <div class="muted">Last updated: Just now</div>
      </div>

      <div class="grid-2">
        <div class="card panel">
          <h2>Quick Actions</h2>
          <div class="qa">
            <a class="qa-item" id="qa-new-post" href="javascript:void(0)">
              <div class="qa-icon">‚úèÔ∏è</div>
              <div><div class="qa-title">Create New Post</div><div class="qa-sub">Write and publish your latest blog entry.</div></div>
              <span class="chev">‚Ä∫</span>
            </a>
            <a class="qa-item" id="qa-new-project" href="javascript:void(0)">
              <div class="qa-icon">üì¶</div>
              <div><div class="qa-title">Add New Project</div><div class="qa-sub">Showcase your newest development project.</div></div>
              <span class="chev">‚Ä∫</span>
            </a>
          </div>
        </div>

        <div class="card panel">
          <h2>Recent Activity</h2>
          <ul class="activity">
            <li><div class="ic">üì∞</div><div><div style="font-weight:500">Post ‚ÄòThe Future of AI‚Äô published.</div><div class="muted" style="font-size:12px">2 mins ago</div></div></li>
            <li><div class="ic">üóÇÔ∏è</div><div><div style="font-weight:500">Project ‚ÄòPortfolio V3‚Äô updated.</div><div class="muted" style="font-size:12px">1 hour ago</div></div></li>
            <li><div class="ic">‚öôÔ∏è</div><div><div style="font-weight:500">Dashboard settings updated.</div><div class="muted" style="font-size:12px">2 hours ago</div></div></li>
            <li><div class="ic">üìù</div><div><div style="font-weight:500">Draft ‚ÄòReact Hooks Deep Dive‚Äô saved.</div><div class="muted" style="font-size:12px">5 hours ago</div></div></li>
            <li><div class="ic">üß±</div><div><div style="font-weight:500">New project ‚ÄòE-commerce API‚Äô created.</div><div class="muted" style="font-size:12px">Yesterday</div></div></li>
          </ul>
        </div>
      </div>

      <div class="stats">
        <div class="card panel stat"><div class="top"><div class="ico">üìÑ</div><div class="muted" style="font-weight:600">Total Posts</div></div><div class="num" id="statPosts">0</div></div>
        <div class="card panel stat"><div class="top"><div class="ico">üìÅ</div><div class="muted" style="font-weight:600">Total Projects</div></div><div class="num" id="statProjects">0</div></div>
        <div class="card panel stat"><div class="top"><div class="ico">üîÑ</div><div class="muted" style="font-weight:600">Items Combined</div></div><div class="num" id="statItems">0</div></div>
      </div>
    </section>

    <!-- POSTS -->
    <section id="posts-section" style="display:none">
      <div class="card panel">
        <h2 id="formTitle">Create New Post</h2>
        <form id="postForm">
          <input type="hidden" id="postId"/>
          <div class="row"><label for="title">Post Title</label><input id="title" type="text" placeholder="Enter post title" required /></div>
          <div class="row"><label for="desc">Description</label><textarea id="desc" placeholder="Write your post content here..."></textarea></div>
          <div class="row">
            <label>Post Image</label>
            <div class="drop">
              <div class="muted" id="noimg">No image selected</div>
              <div class="preview" id="preview" style="display:none"><img id="previewImg" alt="preview"/><button type="button" class="btn gray" id="removeImg">Remove</button></div>
              <div class="row" style="margin:10px 0 0"><input type="file" id="file" accept="image/*" style="display:none"/><button type="button" class="btn" id="pick">Upload Image</button></div>
            </div>
          </div>
          <div class="actions"><button type="button" class="btn gray" id="cancelBtn">Cancel</button><button class="btn primary" id="submitBtn">Create Post</button></div>
        </form>
      </div>

      <section class="card">
        <div class="panel" style="padding-bottom:10px"><h2>Manage Posts</h2><div class="muted" id="status"></div></div>
        <div class="table-wrap">
          <table id="postsTable">
            <thead><tr><th style="width:24%">Title</th><th>Description</th><th style="width:12%">Image</th><th style="width:14%">Date</th><th style="width:12%">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
  // ===== Config =====
  const API_PROJECTS   = "http://localhost:8080/api/projects";
  const API_IMAGES     = "http://localhost:8080/api/images"; // your Posts API
  const token   = localStorage.getItem("jwtToken") || "";
  const username= localStorage.getItem("username") || "Jane Doe";

  // ===== UI helpers =====
  const toastEl = document.getElementById('toast');
  function toast(msg, type=''){ toastEl.textContent=msg; toastEl.className='toast show'+(type?(' '+type):''); setTimeout(()=>toastEl.className='toast', 2200); }
  function setBtnLoading(btn, isLoading, textWhenDone){
    if(!btn) return; btn.disabled=isLoading; btn.dataset.original=btn.dataset.original||btn.textContent;
    btn.textContent = isLoading ? 'Please wait‚Ä¶' : (textWhenDone || btn.dataset.original);
  }

  // ===== Nav + identity =====
  document.getElementById("welcomeName").textContent = username;
  document.getElementById("avatar").textContent = (username[0]||'J').toUpperCase() + (username[1]||'D').toUpperCase();

  const tabs = document.querySelectorAll(".tab");
  const sidebarLinks = { dash:document.getElementById('nav-dashboard'), posts:document.getElementById('nav-posts') };
  function switchTo(tab){
    tabs.forEach(t=>t.classList.toggle('active', t.dataset.tab===tab));
    document.querySelectorAll('.slink').forEach(a=>a.classList.remove('active'));
    if(sidebarLinks[tab]) sidebarLinks[tab].classList.add('active');
    document.getElementById('dash-section').style.display   = tab==='dash'  ? '' : 'none';
    document.getElementById('posts-section').style.display  = tab==='posts' ? '' : 'none';
  }
  tabs.forEach(t=>t.addEventListener('click',()=>switchTo(t.dataset.tab)));
  sidebarLinks.posts.addEventListener('click',()=>switchTo('posts'));
  sidebarLinks.dash.addEventListener('click',()=>switchTo('dash'));
  document.getElementById('logout').addEventListener('click',()=>{ if(confirm('Logout?')){ localStorage.clear(); location.href='index.html'; }});

  // ===== API helpers =====
  const authHeaders = token ? { Authorization:`Bearer ${token}` } : {};
  async function getJSON(url){
    const r = await fetch(url,{headers:authHeaders});
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }
  async function sendMultipart(method, url, fd){
    const r = await fetch(url,{ method, headers:authHeaders, body:fd });
    const text = await r.text();
    if(!r.ok){ throw new Error(text||'Request failed'); }
    try { return JSON.parse(text); } catch { return {}; }
  }
  async function del(url){
    const r = await fetch(url,{ method:'DELETE', headers:authHeaders });
    if(!r.ok) throw new Error(await r.text());
  }

  // ===== Dashboard metrics =====
  async function loadMetrics(){
    try{
      const [projects, images] = await Promise.all([getJSON(API_PROJECTS).catch(()=>[]), getJSON(API_IMAGES).catch(()=>[])]);
      const pCount = Array.isArray(images) ? images.length : 0;
      const projCount = Array.isArray(projects) ? projects.length : 0;
      const total = pCount + projCount;
      const ids = ['metricPosts','statPosts']; ids.forEach(id=>document.getElementById(id).textContent = pCount);
      ['metricProjects','statProjects'].forEach(id=>document.getElementById(id).textContent = projCount);
      ['metricItems','statItems'].forEach(id=>document.getElementById(id).textContent = total);
    }catch(e){ console.error(e); }
  }

  // ===== Posts CRUD =====
  const statusEl = document.getElementById('status');
  function setStatus(m, kind=''){ statusEl.textContent=m||''; statusEl.style.color = kind==='error'?'#ef4444':(kind==='success'?'#16a34a':'#6b7280'); }
  function toDateStr(d){ try{ return new Date(d).toISOString().slice(0,10); }catch{ return '-'; } }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  const form = document.getElementById('postForm');
  const formTitle = document.getElementById('formTitle');
  const postIdEl = document.getElementById('postId');
  const titleEl = document.getElementById('title');
  const descEl = document.getElementById('desc');
  const fileEl = document.getElementById('file');
  const pickBtn = document.getElementById('pick');
  const removeImgBtn = document.getElementById('removeImg');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const noimg = document.getElementById('noimg');
  const cancelBtn = document.getElementById('cancelBtn');
  const submitBtn = document.getElementById('submitBtn');
  const tbody = document.querySelector('#postsTable tbody');

  function resetForm(){
    postIdEl.value=''; titleEl.value=''; descEl.value=''; fileEl.value='';
    preview.style.display='none'; noimg.style.display='';
    submitBtn.textContent='Create Post'; formTitle.textContent='Create New Post';
  }
  function enterEdit(p){
    postIdEl.value=p.id; titleEl.value=p.name||''; descEl.value=p.description||'';
    fileEl.value=''; preview.style.display='none'; noimg.style.display='';
    submitBtn.textContent='Update Post'; formTitle.textContent='Edit Post';
    window.scrollTo({top:0,behavior:'smooth'});
  }

  pickBtn.addEventListener('click',()=>fileEl.click());
  fileEl.addEventListener('change',()=>{
    const f=fileEl.files?.[0];
    if(!f){ preview.style.display='none'; noimg.style.display=''; return; }
    previewImg.src=URL.createObjectURL(f); preview.style.display=''; noimg.style.display='none';
  });
  removeImgBtn.addEventListener('click',()=>{ fileEl.value=''; preview.style.display='none'; noimg.style.display=''; });
  cancelBtn.addEventListener('click', (e)=>{ e.preventDefault(); resetForm(); });

  async function loadPosts(){
    try{
      setStatus('Loading...');
      const list = await getJSON(API_IMAGES);
      tbody.innerHTML='';
      if(!Array.isArray(list) || list.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="muted">No posts yet</td></tr>`;
        setStatus(''); return;
      }
      for(const p of list){
        const tr = document.createElement('tr');

        const tdTitle = document.createElement('td');
        tdTitle.innerHTML = `<div style="font-weight:600">${escapeHtml(p.name||'')}</div>`;
        tr.appendChild(tdTitle);

        const tdDesc = document.createElement('td');
        tdDesc.innerHTML = `<div class="muted">${escapeHtml(p.description||'')}</div>`;
        tr.appendChild(tdDesc);

        const tdImg = document.createElement('td');
        tdImg.className='cell-img';
        tdImg.innerHTML = `<img src="${API_IMAGES}/${p.id}" alt="${escapeHtml(p.name||'')}" />`;
        tr.appendChild(tdImg);

        const tdDate = document.createElement('td');
        tdDate.textContent = toDateStr(p.createdAt || p.updatedAt);
        tr.appendChild(tdDate);

        const tdAct = document.createElement('td');
        tdAct.innerHTML = `
          <div style="display:flex;gap:8px">
            <button class="btn icon" title="Edit">‚úèÔ∏è</button>
            <button class="btn icon danger" title="Delete">üóëÔ∏è</button>
          </div>`;
        const [editBtn, delBtn] = tdAct.querySelectorAll('button');
        editBtn.addEventListener('click',()=>enterEdit(p));
        delBtn.addEventListener('click',async()=>{
          if(!confirm('Delete this post?')) return;
          try{ setBtnLoading(delBtn,true); await del(`${API_IMAGES}/${p.id}`); toast('Post deleted','success'); await loadPosts(); await loadMetrics(); }
          catch(e){ toast(e.message || 'Delete failed','error'); }
          finally{ setBtnLoading(delBtn,false); }
        });
        tr.appendChild(tdAct);

        tbody.appendChild(tr);
      }
      setStatus('');
    }catch(e){ console.error(e); setStatus('Failed to load posts','error'); toast('Failed to load posts','error'); }
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const id = postIdEl.value.trim();
    const name = titleEl.value.trim();
    const description = descEl.value.trim();
    if(!name){ toast('Title is required','error'); return; }

    const fd = new FormData();
    if(id){
      // Update: send only provided fields
      fd.append('name', name);
      fd.append('description', description);
      if(fileEl.files?.[0]) fd.append('file', fileEl.files[0]);
    }else{
      fd.append('name', name);
      if(description) fd.append('description', description);
      if(fileEl.files?.[0]) fd.append('file', fileEl.files[0]);
    }

    try{
      setBtnLoading(submitBtn,true, submitBtn.textContent);
      setStatus(id ? 'Updating...' : 'Creating...');
      const url = id ? `${API_IMAGES}/${id}` : `${API_IMAGES}/upload`;
      const method = id ? 'PUT' : 'POST';
      await sendMultipart(method, url, fd);
      toast(id ? 'Post updated' : 'Post created', 'success');
      resetForm();
      await loadPosts();
      await loadMetrics();
      setStatus('');
    }catch(err){
      console.error(err);
      toast(err.message || 'Save failed', 'error');
      setStatus('Save failed', 'error');
    }finally{
      setBtnLoading(submitBtn,false);
    }
  });

  // Quick actions
  document.getElementById('qa-new-post').addEventListener('click',()=>{ switchTo('posts'); titleEl.focus(); });
  document.getElementById('qa-new-project').addEventListener('click',()=>alert('Projects screen not wired here.'));

  // Boot
  switchTo('dash');
  resetForm();
  loadMetrics();
  loadPosts();
</script>
</body>
</html>
