<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Simple Image Admin</title>
  <style>
    body{font-family:system-ui,arial,sans-serif; margin:20px; color:#111}
    .row{display:flex; gap:16px; align-items:center; margin-bottom:12px}
    table{border-collapse:collapse; width:100%; margin-top:16px}
    th,td{border:1px solid #ddd; padding:8px; vertical-align:top}
    img{max-width:160px; max-height:120px; border:1px solid #ccc; border-radius:6px}
    .alert{padding:8px 10px; border-radius:6px; margin:8px 0}
    .error{background:#fde2e2; border:1px solid #f5b5b5}
    .ok{background:#e2f6e9; border:1px solid #a7e0bd}
    .btn{padding:6px 10px; border:1px solid #ccc; background:#f6f6f6; border-radius:6px; cursor:pointer}
  </style>
</head>
<body>

<h1>Simple Image Admin</h1>

<div>
  <h3>Upload</h3>
  <div id="uploadMsg"></div>
  <form id="uploadForm">
    <div class="row">
      <label>Name <input name="name" required></label>
      <label>File <input name="file" type="file" accept="image/*" required></label>
    </div>
    <div class="row">
      <label style="flex:1">Description<br>
        <textarea name="description" rows="3" style="width:100%"></textarea>
      </label>
    </div>
    <button class="btn" type="submit">Upload</button>
  </form>
</div>

<hr>

<h3>Images</h3>
<div id="listMsg"></div>
<table>
  <thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Preview</th><th>Actions</th></tr></thead>
  <tbody id="rows"><tr><td colspan="5">Loading...</td></tr></tbody>
</table>

<!-- Simple edit modal -->
<dialog id="editDlg">
  <form id="editForm" method="dialog">
    <h3>Edit</h3>
    <input type="hidden" name="id">
    <div class="row"><label>Name <input name="name"></label></div>
    <div class="row" style="align-items:flex-start"><label style="flex:1">Description<br>
      <textarea name="description" rows="3" style="width:100%"></textarea></label>
    </div>
    <div class="row"><label>Replace Image <input name="file" type="file" accept="image/*"></label></div>
    <div class="row" style="justify-content:flex-end; gap:8px">
      <button class="btn" type="button" id="cancelEdit">Cancel</button>
      <button class="btn" type="submit" id="saveEdit">Save</button>
    </div>
  </form>
</dialog>

<script>
const API = 'http://localhost:8080';
const $ = s => document.querySelector(s);

const show = (el,msg,ok=false)=>{ el.innerHTML = `<div class="alert ${ok?'ok':'error'}">${msg}</div>`; setTimeout(()=> el.innerHTML='', 3000); };

async function getJSON(path){
  const res = await fetch(API+path);
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}
async function postMultipart(path, fd){
  const res = await fetch(API+path, { method:'POST', body: fd });
  if(!res.ok) throw new Error('HTTP '+res.status);
  try { return await res.json(); } catch { return {}; }
}
async function del(path){
  const res = await fetch(API+path, { method:'DELETE' });
  if(!res.ok) throw new Error('HTTP '+res.status);
}

let items = [];

function render(){
  const tbody = $('#rows');
  if(!items.length){ tbody.innerHTML = `<tr><td colspan="5">No images yet.</td></tr>`; return; }
  tbody.innerHTML = items.map(p => `
    <tr>
      <td>${p.id}</td>
      <td>${escapeHtml(p.name||'')}</td>
      <td>${escapeHtml(p.description||'')}</td>
      <td>${p.url ? `<img src="${p.url}" alt="${escapeHtml(p.name||'')}">` : 'â€”'}</td>
      <td>
        <button class="btn" onclick="openEdit(${p.id})">Edit</button>
        <button class="btn" onclick="removeItem(${p.id})">Delete</button>
      </td>
    </tr>
  `).join('');
}

function escapeHtml(s=''){
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

async function load(){
  try{
    items = await getJSON('/api/images');
    render();
  }catch(e){
    show($('#listMsg'), 'Failed to load: '+e.message);
  }
}

$('#uploadForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const f = ev.currentTarget;
  const fd = new FormData();
  if(!f.name.value || !f.file.files[0]){ show($('#uploadMsg'), 'name and file are required'); return; }
  fd.append('name', f.name.value);
  if(f.description.value) fd.append('description', f.description.value);
  fd.append('file', f.file.files[0]);
  try{
    const created = await postMultipart('/api/images/upload', fd);
    items.unshift(created);
    render();
    f.reset();
    show($('#uploadMsg'), 'uploaded', true);
  }catch(e){
    show($('#uploadMsg'), 'upload failed: '+e.message);
  }
});

window.openEdit = (id)=>{
  const p = items.find(x=> x.id===id);
  if(!p) return;
  const d = $('#editDlg');
  d.querySelector('input[name="id"]').value = id;
  d.querySelector('input[name="name"]').value = p.name||'';
  d.querySelector('textarea[name="description"]').value = p.description||'';
  d.showModal();
};

$('#cancelEdit').addEventListener('click', ()=> $('#editDlg').close());

$('#editForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const d = $('#editDlg');
  const id = d.querySelector('input[name="id"]').value;
  const name = d.querySelector('input[name="name"]').value;
  const desc = d.querySelector('textarea[name="description"]').value;
  const file = d.querySelector('input[name="file"]').files[0];
  const fd = new FormData();
  if(name) fd.append('name', name);
  fd.append('description', desc || '');
  if(file) fd.append('file', file);

  try{
    const updated = await postMultipart('/api/images/'+id, fd); // POST update
    const ix = items.findIndex(x=> x.id == id);
    if(ix>-1) items[ix] = updated;
    render();
    d.close();
  }catch(e){
    alert('update failed: '+e.message);
  }
});

window.removeItem = async (id)=>{
  if(!confirm('delete this image?')) return;
  try{
    await del('/api/images/'+id);
    items = items.filter(x=> x.id!==id);
    render();
  }catch(e){
    alert('delete failed: '+e.message);
  }
};

load();
</script>
</body>
</html>
